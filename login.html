<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å…¥ - å°ˆæ¡ˆå ±å‚™ç³»çµ±</title>
    <link rel="stylesheet" href="style.css">
    
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1>ğŸ” ç³»çµ±ç™»å…¥</h1>
                <p>å°ˆæ¡ˆå ±å‚™ç³»çµ±</p>
            </div>

            <div id="errorMessage" class="error-message"></div>

            <form id="loginForm" class="login-form">
                <div class="form-group">
                    <label for="username">ä½¿ç”¨è€…å¸³è™Ÿ</label>
                    <input 
                        type="text" 
                        id="username" 
                        name="username" 
                        required 
                        autofocus
                        placeholder="è«‹è¼¸å…¥å¸³è™Ÿ"
                        autocomplete="username">
                </div>

                <div class="form-group">
                    <label for="password">å¯†ç¢¼</label>
                    <div class="password-toggle">
                        <input 
                            type="password" 
                            id="password" 
                            name="password" 
                            required 
                            placeholder="è«‹è¼¸å…¥å¯†ç¢¼"
                            autocomplete="current-password">
                        <button type="button" class="toggle-password" id="togglePassword">ğŸ‘ï¸</button>
                    </div>
                </div>

                <button type="submit" class="login-btn" id="loginBtn">
                    ç™»å…¥
                </button>
            </form>
        </div>
    </div>

    <script>
        // ç™»å…¥è™•ç†
        const loginForm = document.getElementById('loginForm');
        const errorMessage = document.getElementById('errorMessage');
        const loginBtn = document.getElementById('loginBtn');
        const togglePassword = document.getElementById('togglePassword');
        const passwordInput = document.getElementById('password');

        // å¯†ç¢¼é¡¯ç¤ºåˆ‡æ›
        togglePassword.addEventListener('click', () => {
            const type = passwordInput.type === 'password' ? 'text' : 'password';
            passwordInput.type = type;
            togglePassword.textContent = type === 'password' ? 'ğŸ‘ï¸' : 'ğŸ™ˆ';
        });

        // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
        const token = localStorage.getItem('auth_token');
        if (token) {
            // é©—è­‰ token æ˜¯å¦æœ‰æ•ˆ
            fetch('http://localhost:8080/auth/me', {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            })
            .then(response => {
                if (response.ok) {
                    // Token æœ‰æ•ˆ,ç›´æ¥è·³è½‰
                    window.location.href = 'index.html';
                }
            })
            .catch(() => {
                // Token ç„¡æ•ˆ,æ¸…é™¤ä¸¦ç¹¼çºŒé¡¯ç¤ºç™»å…¥é 
                localStorage.removeItem('auth_token');
                localStorage.removeItem('user_info');
            });
        }

        // è¡¨å–®æäº¤
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            // éš±è—éŒ¯èª¤è¨Šæ¯
            errorMessage.classList.remove('show');
            errorMessage.textContent = '';

            // ç¦ç”¨æŒ‰éˆ•
            loginBtn.disabled = true;
            loginBtn.textContent = 'ç™»å…¥ä¸­...';

            try {
                const response = await fetch('http://localhost:8080/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password
                    })
                });

                const data = await response.json();
                console.log('Login response:', data);

                if (data.code === 200 && data.body && data.body.token) {
                    // ç™»å…¥æˆåŠŸ
                    const userInfo = {
                        id: data.body.id,
                        username: data.body.username,
                        role: data.body.role
                    };

                    // å„²å­˜ token å’Œä½¿ç”¨è€…è³‡è¨Š
                    localStorage.setItem('auth_token', data.body.token);
                    localStorage.setItem('user_info', JSON.stringify(userInfo));

                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    alert('âœ… ç™»å…¥æˆåŠŸ!');

                    // è·³è½‰åˆ°é¦–é 
                    window.location.href = 'index.html';
                } else {
                    // ç™»å…¥å¤±æ•—
                    throw new Error(data.message || 'ç™»å…¥å¤±æ•—,è«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼');
                }
            } catch (error) {
                console.error('Login error:', error);
                
                // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                errorMessage.textContent = error.message || 'ç™»å…¥å¤±æ•—,è«‹ç¨å¾Œå†è©¦';
                errorMessage.classList.add('show');

                // æ¢å¾©æŒ‰éˆ•
                loginBtn.disabled = false;
                loginBtn.textContent = 'ç™»å…¥';

                // æ¸…ç©ºå¯†ç¢¼
                passwordInput.value = '';
                passwordInput.focus();
            }
        });

        // Enter éµæäº¤
        passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginForm.dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>